# docker file for BEAST 1.8.4 and beagle compiled with the PGI compiler pgc under ubuntu 16.04


# NOTE: 2017-11-06: this version does NOT compile correctly using pgc. An issue has been lodged with
# the beagle people.
FROM hopobcn/pgi-ce

MAINTAINER wscott@cfenet.ubc.ca


WORKDIR /root

# --one_instantiation_per_object
# CFLAGS='-O3 -march=core2 -msse2' CXXFLAGS='-O3 -march=core2 -msse2' ;\
# ---------------- install beagle ------------------------
RUN apt-get -y update && apt-get -y upgrade
RUN apt-get -y install autoconf automake m4 libtool default-jdk ;\
  mkdir beagle; cd beagle ;\
  git clone --depth=1 https://github.com/beagle-dev/beagle-lib.git . ;\
  ./autogen.sh ;\
  ./configure --prefix=/usr/local/beagle-lib-master CFLAGS='-O3 -march=core2 -msse2' CXXFLAGS='-O3 -march=core2 -msse2' ;\
  make ;\
  mkdir -p /usr/local/beagle-lib-master/include  ;\
  install -m 644 libhmsbeagle/beagle.h libhmsbeagle/platform.h     /usr/local/beagle-lib-master/include  ;\
mkdir -p /usr/local/beagle-lib-master/lib ;\
install -m 755 libhmsbeagle/CPU/.libs/*.so.21.0.0 /usr/local/beagle-lib-master/lib ;\
install -m 755 libhmsbeagle/CPU/.libs/*.la        /usr/local/beagle-lib-master/lib ;\
install -m 755 libhmsbeagle/.libs/*.so* /usr/local/beagle-lib-master/lib ;\
install -m 755 libhmsbeagle/.libs/*.la       /usr/local/beagle-lib-master/lib ;\
install -m 755 libhmsbeagle/JNI/libhmsbeagle-jni.la       /usr/local/beagle-lib-master/lib ;\
install -m 755 libhmsbeagle/JNI/.libs/libhmsbeagle-jni.so /usr/local/beagle-lib-master/lib ;\
apt-get -y remove autoconf automake m4 libtool default-jdk ;\
cd ..; rm -rf beagle

# ------------------ install beast -----------------------
RUN mkdir beast ; cd beast ;\
   yum install -y wget java-1.8.0-openjdk-devel.x86_64 javapackages-tools.noarch; \
   wget https://github.com/beast-dev/beast-mcmc/releases/download/v1.8.4/BEASTv1.8.4.tgz ;\
   tar -zxvf BEASTv1.8.4.tgz ;\
   mkdir -p /usr/local/BEAST-1.8.4/bin  ;\
   mkdir -p /usr/local/BEAST-1.8.4/lib ;\
   mkdir -p /usr/local/BEAST-1.8.4/doc ;\
   mkdir -p /usr/local/BEAST-1.8.4/examples;\
   mkdir -p /usr/local/BEAST-1.8.4/images;\
   mkdir -p /usr/local/BEAST-1.8.4/native;\
   cp  BEASTv1.8.4/bin/* /usr/local/BEAST-1.8.4/bin/. ;\
     chmod 755 /usr/local/BEAST-1.8.4/bin/*  ;\
   cp  BEASTv1.8.4/lib/* /usr/local/BEAST-1.8.4/lib/. ;\
     chmod 444 /usr/local/BEAST-1.8.4/lib/* ;\
   cp  BEASTv1.8.4/doc/* /usr/local/BEAST-1.8.4/doc/. ;\
     chmod 444 /usr/local/BEAST-1.8.4/doc/* ;\
   cp  -R BEASTv1.8.4/examples/* /usr/local/BEAST-1.8.4/examples/. ;\
     chmod -R 444 /usr/local/BEAST-1.8.4/examples/* ;\
   cp  BEASTv1.8.4/images/* /usr/local/BEAST-1.8.4/images/.  ;\
     chmod 444 /usr/local/BEAST-1.8.4/images/* ;\
   cp  BEASTv1.8.4/native/* /usr/local/BEAST-1.8.4/native/. ;\
     chmod 444 /usr/local/BEAST-1.8.4/native/* ;\
   ln -s /usr/local/BEAST-1.8.4/bin/beast /usr/local/bin/beast ;\
   ln -s /usr/local/BEAST-1.8.4/bin/beauti /usr/local/bin/beauti  ;\
   ln -s /usr/local/BEAST-1.8.4/bin/loganalyser /usr/local/bin/loganalyser ;\
   ln -s /usr/local/BEAST-1.8.4/bin/logcombiner /usr/local/bin/logcombiner ;\
   ln -s /usr/local/BEAST-1.8.4/bin/treeannotator /usr/local/bin/treeannotator ;\
   ln -s /usr/local/BEAST-1.8.4/bin/treestat /usr/local/bin/treestat ;\
   ln -s /usr/local/BEAST-1.8.4/lib/beast.jar /usr/local/lib/beast.jar ;\
   ln -s /usr/local/BEAST-1.8.4/lib/beauti.jar /usr/local/lib/beauti.jar ;\
   ln -s /usr/local/BEAST-1.8.4/lib/libNucleotideLikelihoodCore32.so /usr/local/lib/libNucleotideLikelihoodCore32.so ;\
   ln -s /usr/local/BEAST-1.8.4/lib/libNucleotideLikelihoodCore.so /usr/local/lib/libNucleotideLikelihoodCore.so ;\
   yum remove -y wget java-1.8.0-openjdk-devel.x86_64;\
   cd ..; rm -rf beast
  

ENV LD_LIBRARY_PATH /usr/local/beagle-lib-master/lib

CMD cd /mnt/input && /usr/local/bin/beast *.xml && mv *.trees *.ops *.log /mnt/output
